<% invoiced_spend = @project_tracker.invoiced_spend %>
<% running_spend = @project_tracker.running_spend %>
<% budget_low_end = @project_tracker.budget_low_end %>
<% budget_high_end = @project_tracker.budget_high_end %>
<% current_spend = invoiced_spend + running_spend %>
<% estimated_cost = @project_tracker.estimated_cost %>
<% revenue = @project_tracker.revenue %>

<% inbudget_overage = (
  budget_low_end.present? ?
  [current_spend - budget_low_end, 0].max :
  0
)%>
<% overbudget_overage = (
  budget_high_end.present? ?
  [current_spend - budget_high_end, 0].max :
  0
)%>

<% limit = [
  1, # Ensures we don't divide by zero
  invoiced_spend,
  current_spend,
  budget_low_end,
  budget_high_end
].compact.max %>

<% if @project_tracker.project_capsule.present? && @project_tracker.work_completed_at.present? %>
  <% project_capsule = @project_tracker.project_capsule %>

  <div class="title_bar" id="title_bar" style="padding: 80px 0px 20px 0px;">
    <div id="titlebar_left">
      <h2 id="page_title">ðŸ’Š Project Capsule</h2>
    </div>
    <div id="titlebar_right">
      <%= link_to "Edit Project Capsule â†—", edit_admin_project_capsule_path(@project_tracker.project_capsule.id) %>
    </div>
  </div>

  <% if project_capsule.complete? %>
    <div class="dashboard-modules table index_table index">
      <div class="dashboard-module">
        <div class="module-header">
          <p>Wrapup Status</p>
          <% if project_capsule.client_feedback_survey_url.present? %>
            <%= link_to "Client Survey URL â†—", project_capsule.client_feedback_survey_url %>
          <% end %>
        </div>
        <div class="module-body">

          <table border="0" cellspacing="0" cellpadding="0" class="index_table index">
            <tbody>
              <tr class="odd">
                <td class="col"><strong>Client Feedback</strong></td>
                <td class="col text-right">
                  <%= project_capsule.client_feedback_survey_status.humanize %>
                </td>
              </tr>
              <tr class="even">
                <td class="col"><strong>Marketing</strong></td>
                <td class="col text-right">
                  <%= project_capsule.internal_marketing_status.humanize %>
                </td>
              </tr>
              <tr class="odd">
                <td class="col"><strong>Internal Sharing</strong></td>
                <td class="col text-right">
                  <%= project_capsule.capsule_status.humanize %>
                </td>
              </tr>
            </tbody>
          </table>

        </div>
      </div>
      <div class="dashboard-module">
        <div class="module-header">
          <p>Profitability Study</p>
        </div>
        <div class="module-body">
          <table border="0" cellspacing="0" cellpadding="0" class="index_table index">
            <tbody>
              <tr class="odd">
                <td class="col"><strong>Raw Resourcing Cost</strong></td>
                <td class="col text-right">
                  <%= number_to_currency(@project_tracker.raw_resourcing_cost) %>
                </td>
              </tr>
              <tr class="even">
                <td class="col"><strong>Estimated COGS</strong></td>
                <td class="col text-right">
                  <%= number_to_currency(estimated_cost) %>
                </td>
              </tr>
              <tr class="odd">
                <td class="col"><strong>Total Revenue</strong></td>
                <td class="col text-right">
                  <%= number_to_currency(revenue) %>
                </td>
              </tr>
              <tr class="even">
                <td class="col"><strong>Total Profit</strong></td>
                <td class="col text-right">
                  <%= number_to_currency(revenue - estimated_cost) %>
                </td>
              </tr>
              <tr class="odd">
                <td class="col"><strong>Profit Margin</strong></td>
                <td class="col text-right">
                  <%= (((revenue - estimated_cost) / estimated_cost) * 100).round(2) %>%
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="dashboard-modules table index_table index">
      <div class="dashboard-module">
        <div class="module-header">
          <p>Postpartum Meeting Notes</p>
        </div>
        <div class="module-body markdown-body">
          <%= sanitize RDiscount.new(project_capsule.postpartum_notes).to_html %>
        </div>
      </div>
    </div>
  <% else %>
    <div class="dashboard-modules table index_table index">
      <div class="dashboard-module">
        <div class="module-body factoid-parent">
          <p style="margin-bottom: 6px;">ðŸš§ This project is complete, but the project team have not yet completed their Project Capsule.</p>
        <a href="https://www.notion.so/garden3d/TODO-How-to-Wrap-a-Project-a249d0340d21447897c7a261e2b40ab3" target="_blank">
          Learn how to Wrap a Project â†—
        </a>
        </div>
      </div>
    </div>

  <% end %>

  <div class="title_bar" id="title_bar" style="padding: 80px 0px 20px 0px;">
    <div id="titlebar_left">
      <h2 id="page_title">Project Details</h2>
    </div>
  </div>
<% end %>


<p class="pill nag <%= @project_tracker.status %>" style="margin-bottom: 0px;margin-right: 6px;">
  <%= @project_tracker.status.to_s.humanize %>
</p>
<% @project_tracker.project_tracker_links.each do |link| %>
  <a href="<%= link.url %>" target="_blank" style="margin-right: 6px">
    <p class="nag" style="margin-bottom: 0px;margin-right: 6px;">
      <%= link.name %> â†—
    </p>
  </a>
<% end %>

<div class="skill_tree_hint markdown-body" style="margin-top: 40px; margin-bottom:40px;">
  <%= sanitize RDiscount.new(@project_tracker.notes).to_html %>

  <% if @project_tracker.current_atc.present? %>
    <p style="margin-top:80px;"><strong>Project ATC: </strong><%= link_to @project_tracker.current_atc.email, admin_admin_user_path(@project_tracker.current_atc) %></p>
  <% end %>
</div>

<div class="dashboard-modules table index_table index">
  <div class="dashboard-module">
    <div class="module-header">
      <p>Budget Progress</p>
      <span class="pill <%= @project_tracker.status %>">
        <%= @project_tracker.status.to_s.humanize %>
      </span>
    </div>
    <div class="module-body">
      <div class="budget_progress_bars">
        <% if inbudget_overage > 0 %>
          <div
            class="bar invoiced"
            style="width:calc(<%= (([invoiced_spend, budget_low_end].min / limit) * 100).round(2) %>%)">
          </div>

          <div class="multibar">
            <% if overbudget_overage > 0 %>
              <div
                class="bar budget_low_end"
                style="width:<%= (((inbudget_overage - overbudget_overage) / limit) * 100).round(2) %>%;left:<%= (((invoiced_spend + (running_spend - inbudget_overage)) / limit) * 100).round(2) %>%">
              </div>
              <div
                class="bar budget_high_end"
                style="width:<%= (((overbudget_overage) / limit) * 100).round(2) %>%;left:<%= (((invoiced_spend + (running_spend - inbudget_overage) + (inbudget_overage - overbudget_overage)) / limit) * 100).round(2) %>%">
              </div>
            <% else %>
              <div
                class="bar budget_low_end"
                style="width:<%= (((inbudget_overage) / limit) * 100).round(2) %>%;left:<%= (((invoiced_spend +(running_spend - inbudget_overage)) / limit) * 100).round(2) %>%">
              </div>
            <% end %>
          </div>
        <% else %>
          <div
            class="bar invoiced"
            style="width:calc(<%= ((invoiced_spend / limit) * 100).round(2) %>%)">
          </div>
          <div
            class="bar running"
            style="width:<%= (((running_spend) / limit) * 100).round(2) %>%;left:<%= ((invoiced_spend / limit) * 100).round(2) %>%">
          </div>
        <% end %>

        <% if budget_low_end.present? %>
          <div
            class="cursor budget_low_end"
            style="left:calc(<%= (((budget_low_end) / limit) * 100).round(2) %>% - 6px)">
          </div>
        <% end %>

        <% if budget_high_end.present? %>
          <div
            class="cursor budget_high_end"
            style="left:calc(<%= (((budget_high_end) / limit) * 100).round(2) %>% - 6px)">
          </div>
        <% end %>
      </div>

      <div class="budget_progress_legend">
        <span class="legend_item">
          <div class="legend_item_dot invoiced"></div>
          <p>Invoiced Spend</p>
        </span>
        <span class="legend_item">
          <div class="legend_item_dot running"></div>
          <p>Under Budget Spend</p>
        </span>
        <span class="legend_item">
          <div class="legend_item_dot budget_low_end"></div>
          <p>At Budget Spend</p>
        </span>
        <span class="legend_item">
          <div class="legend_item_dot budget_high_end"></div>
          <p>Over Budget Spend</p>
        </span>
      </div>
    </div>
  </div>
</div>

<table border="0" cellspacing="0" cellpadding="0" class="index_table index" style="margin-bottom:20px;">
  <tbody>
    <tr class="odd">
      <td class="col">Invoiced Spend</td>
      <td class="col">
        <%= number_to_currency(invoiced_spend) %>
      </td>
    </tr>
    <tr class="even">
      <td class="col">Running Spend (Since last invoice)</td>
      <td class="col">
        <%= number_to_currency(running_spend) %>
      </td>
    </tr>
    <tr class="odd">
      <td class="col">Total Spend to Date (Invoiced & Running Spends)</td>
      <td class="col">
        <%= number_to_currency(current_spend) %>
      </td>
    </tr>

    <% if budget_low_end.present? %>
      <tr class="even">
        <td class="col">Budget Low End</td>
        <td class="col">
          <%= number_to_currency(budget_low_end) %>
        </td>
      </tr>
      <tr class="odd">
        <td class="col">Budget High End</td>
        <td class="col">
          <%= number_to_currency(budget_high_end) %>
        </td>
      </tr>
      <% if inbudget_overage > 0 %>
        <tr class="even">
          <td class="col">At Budget Spend</td>
          <td class="col">
            <span class=""><%= number_to_currency(inbudget_overage) %></span>
          </td>
        </tr>
      <% end %>
      <% if overbudget_overage > 0 %>
        <tr class="odd">
          <td class="col">Over Budget Spend</td>
          <td class="col">
            <%= number_to_currency(overbudget_overage) %>
          </td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<% if @project_tracker.last_month_value > 0 %>
  <div class="dashboard-modules table index_table index">
    <div class="dashboard-module">
      <div class="module-body factoid-parent">
        <div class="factoid">
          <h2><%= number_to_currency(@project_tracker.last_month_value) %></h2>
          <p>Last month's spend</p>
        </div>
      </div>
    </div>

    <% if budget_low_end %>
      <div class="dashboard-module">
        <div class="module-body factoid-parent">
          <div class="factoid">
              <% if inbudget_overage == 0 %>
                <h2>
                  <%= ((budget_low_end - current_spend) / @project_tracker.last_month_value).round(1) %> months
                </h2>
                <% if budget_low_end == budget_high_end %>
                  <p>Remaining in <strong class="color-red">Budget High End</strong> (based on last month's spend)</p>
                <% else %>
                  <p>Remaining in <strong class="color-orange">Budget Low End</strong> (based on last month's spend)</p>
                <% end %>
              <% elsif overbudget_overage > 0 %>
                <h2 class="color-red">
                  -<%= number_to_currency(overbudget_overage) %>
                </h2>
                <p>Overbudget</p>
              <% else %>
                <h2>
                  <%= ((budget_high_end - current_spend) / @project_tracker.last_month_value).round(1) %> months
                </h2>
                <p>Remaining in <strong class="color-red">Budget High End</strong> (based on last month's spend)</p>
              <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% end %>

<div class="dashboard-modules table index_table index">
  <div class="dashboard-module">
    <div class="module-body factoid-parent">
      <p style="margin-bottom: 6px;">ðŸ¤” <strong>Remember!</strong> Donâ€™t artificially adjust your hours to meet a budget, or we won't get the data we need to improve our proposals.</p>
      <a href="https://www.notion.so/garden3d/How-to-Record-your-Hours-ff971848f66d40cf818b930f05cfc533" target="_blank">
        How to Record your Hours â†—
      </a>
    </div>
  </div>
</div>

<table border="0" cellspacing="0" cellpadding="0" class="index_table index" style="margin-bottom:20px;">
  <thead>
    <tr>
      <th class="col">
        <div class="icon-and-text">
          <%= image_tag("forecast-logo-icon.webp") %>
          Hours
        </div>
      </th>
      <th class="col">Rate</th>
      <th class="col">Hours (Last Month)</th>
      <th class="col">Hours (Total)</th>
      <th class="col">Spend (Total)</th>
    </tr>
  </thead>
  <tbody>
    <% @project_tracker.forecast_projects.each_with_index do |fp, index| %>
      <tr class="<%= index.even? ? "even" : "odd" %>">
        <td class="col">
          <a href="<%= fp.link %>" target="_blank">
            <%= fp.display_name %>
          </a>
        </td>
        <td class="col">
          <%= number_to_currency(fp.hourly_rate) %>
        </td>
        <td class="col">
          <%= fp.total_hours_during_range(Date.today.last_month.beginning_of_month, Date.today.last_month.end_of_month) %>
        </td>
        <td class="col">
          <%= fp.total_hours %>
        </td>
        <td class="col">
          <%= number_to_currency(fp.total_hours * fp.hourly_rate) %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<table border="0" cellspacing="0" cellpadding="0" class="index_table index">
  <thead>
    <tr>
      <th class="col">
        <div class="icon-and-text">
          <%= image_tag("qbo-logo-icon.png") %>
          Invoices
        </div>
      </th>
      <th class="col">Status</th>
      <th class="col">Total (For this Project Tracker)</th>
    </tr>
  </thead>
  <tbody>
    <% @project_tracker.invoice_trackers.each_with_index do |it, index| %>
      <tr class="<%= index.even? ? "even" : "odd" %>">
        <td class="col">
          <%= link_to it.display_name, admin_invoice_pass_invoice_tracker_path(it.invoice_pass, it) %>
        </td>
        <td class="col">
          <span class="pill <%= it.status %>">
            <%= it.status.to_s.humanize %>
          </span>
        </td>
        <td class="col">
          <%= number_to_currency(it.qbo_line_items_relating_to_forecast_projects(@project_tracker.forecast_projects).map{|qbo_li| qbo_li.dig("amount").to_f}.reduce(&:+)) %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

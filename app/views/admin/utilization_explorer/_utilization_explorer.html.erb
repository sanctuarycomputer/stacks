<% periods = data[:month][:periods].reverse %>
<% utilization = data[:month][:utilization] %>

<% periods.each do |period| %>
  <div class="title_bar" id="title_bar" style="padding: 80px 0px 20px 0px;">
    <div id="titlebar_left">
      <h2 id="page_title">
        <%= period.label %>
      </h2>
    </div>
  </div>

  <table border="0" cellspacing="0" cellpadding="0" class="index_table index">
    <thead>
      <tr>
        <th class="col">Person</th>
        <th class="col">Sellable</th>
        <th class="col">Non Sellable</th>
        <th class="col">Time Off</th>
        <th class="col">Non Billable</th>
        <th class="col">Actual Hours Sold</th>
        <th class="col text-right">Health</th>
      </tr>
    </thead>
    <tbody>
      <% utilization.reject{|fp, d| d[period.label].nil?}.each_with_index do |tuple, index| %>
        <% fp = tuple[0] %>
        <% d = tuple[1][period.label] %>
        <% total_billable = (d[:billable].values.reduce(&:+) || 0).round(2) %>

        <tr class="<%= index.even? ? "even" : "odd" %>">
          <td class="col">
            <%= fp.email %>
          </td>
          <td class="col">
            <%= d[:sellable].round(2) %>
          </td>
          <td class="col">
            <%= d[:non_sellable].round(2) %>
          </td>
          <td class="col">
            <%= d[:time_off].round(2) %>
          </td>
          <td class="col">
            <%= d[:non_billable].round(2) %>
          </td>
          <td class="col">
            <%= total_billable %>
          </td>
          <td class="col text-right">
            <% surplus = (total_billable - d[:sellable]).round(2) %>
            <% extreme = surplus.abs > 20 %>
            <% health = surplus >= 0 ? (extreme ? :exceptional : :healthy) : (extreme ? :failing : :at_risk) %>
            <span class="pill <%= health %>" style="margin-right: 6px;">
              <%= health.to_s.humanize %>
              <span class="split natural">
                <% if surplus >= 0 %>+<% else %>-<% end %>
                <%= surplus.abs %>
              </span>
            </span>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>
